services:
  s3local:
    build:
      context: ../api
      dockerfile: Dockerfile.dev
    container_name: s3local
    ports:
      - "8080:8080"
    volumes:
      # Mount source code for hot reloading
      - ../api:/app
      # Persist database
      - s3local-data:/data
      # Cache Go modules
      - go-modules:/go/pkg/mod
    environment:
      - PORT=8080
      - HOST=0.0.0.0
      - DB_PATH=/data/s3local.db
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]

  elasticmq:
    image: softwaremill/elasticmq-native:latest
    container_name: elasticmq
    ports:
      - "9324:9324"
      - "9325:9325"
    volumes:
      - ./elasticmq.conf:/opt/elasticmq.conf
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9324/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  lambda:
    build:
      context: ./lambda
      dockerfile: Dockerfile
    container_name: lambda
    ports:
      - "8081:8080"
    environment:
      - LOG_LEVEL=INFO
    depends_on:
      - s3local
    restart: unless-stopped

  terraform:
    image: hashicorp/terraform:latest
    container_name: terraform
    working_dir: /terraform
    volumes:
      - ./terraform:/terraform
    entrypoint: ["/bin/sh", "-c"]
    environment:
      - AWS_ACCESS_KEY=s3local
      - AWS_SECRET_ACCESS_KEY=s3local
    command:
      - |
        terraform init
        terraform apply -auto-approve
    depends_on:
      s3local:
        condition: service_healthy
    restart: "no"
volumes:
  s3local-data:
    driver: local
  go-modules:
    driver: local
